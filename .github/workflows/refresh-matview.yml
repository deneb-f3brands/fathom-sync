name: refresh-matview

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'   # optional: hourly — change or remove as you like

jobs:
  call-edge-refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Validate secrets (quick)
        run: |
          if [ -z "${{ secrets.EDGE_REFRESH_URL }}" ]; then
            echo "❌ Missing EDGE_REFRESH_URL (set to your Supabase Edge function URL)"; exit 1;
          fi
          if [ -z "${{ secrets.EDGE_REFRESH_SECRET }}" ]; then
            echo "❌ Missing EDGE_REFRESH_SECRET (set to the refresh secret you created in Supabase)"; exit 1;
          fi
          echo "✅ required secrets present"

      - name: Call Supabase Edge Function (x-refresh-secret)
        env:
          EDGE_URL: ${{ secrets.EDGE_REFRESH_URL }}
          EDGE_SECRET: ${{ secrets.EDGE_REFRESH_SECRET }}
        run: |
          set -euo pipefail
          BODY='{"source":"github_actions"}'
          echo "Calling Supabase Edge Function with x-refresh-secret..."
          # call and capture http code + body
          R=$(curl -s -w "\n%{http_code}" -X POST "$EDGE_URL" \
                -H "Content-Type: application/json" \
                -H "x-refresh-secret: $EDGE_SECRET" \
                -d "$BODY" || true)
          HTTP=$(echo "$R" | tail -n1 || echo "")
          RESP=$(echo "$R" | sed '$d' || echo "")
          echo "HTTP: $HTTP"
          echo "BODY:"
          echo "$RESP"
          if [ "$HTTP" = "200" ] || [ "$HTTP" = "201" ]; then
            echo "✅ matview refreshed."
            exit 0
          else
            echo "❌ Edge call failed with HTTP $HTTP"
            exit 1
          fi
