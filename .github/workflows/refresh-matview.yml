name: refresh-matview-debug

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  call-edge-refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Validate secrets (quick)
        run: |
          if [ -z "${{ secrets.EDGE_REFRESH_URL }}" ]; then
            echo "❌ Missing EDGE_REFRESH_URL"; exit 1;
          fi
          if [ -z "${{ secrets.EDGE_REFRESH_SECRET }}" ]; then
            echo "❌ Missing EDGE_REFRESH_SECRET"; exit 1;
          fi
          echo "✅ Secrets exist"

      - name: Invoke Supabase Edge Function (try 2 header styles)
        env:
          EDGE_URL: ${{ secrets.EDGE_REFRESH_URL }}
          EDGE_SECRET: ${{ secrets.EDGE_REFRESH_SECRET }}
        run: |
          set -euo pipefail

          echo "DEBUG: EDGE_URL length = ${#EDGE_URL}"
          echo "DEBUG: EDGE_SECRET length = ${#EDGE_SECRET}"
          BODY='{"source":"github_actions_debug"}'

          echo
          echo ">>> Attempt 1: header x-refresh-secret"
          R1=$(curl -s -w "\n%{http_code}" -X POST "$EDGE_URL" \
               -H "Content-Type: application/json" \
               -H "x-refresh-secret: $EDGE_SECRET" \
               -d "$BODY" || true)
          HTTP1=$(echo "$R1" | tail -n1 || echo "")
          BODY1=$(echo "$R1" | sed '$d' || echo "")
          echo "HTTP1: $HTTP1"
          echo "BODY1:"
          echo "$BODY1"

          echo
          echo ">>> Attempt 2: Authorization: Bearer <secret>"
          R2=$(curl -s -w "\n%{http_code}" -X POST "$EDGE_URL" \
               -H "Content-Type: application/json" \
               -H "Authorization: Bearer $EDGE_SECRET" \
               -d "$BODY" || true)
          HTTP2=$(echo "$R2" | tail -n1 || echo "")
          BODY2=$(echo "$R2" | sed '$d' || echo "")
          echo "HTTP2: $HTTP2"
          echo "BODY2:"
          echo "$BODY2"

          echo
          echo "Summary:"
          echo "  attempt 1 (x-refresh-secret) -> HTTP $HTTP1"
          echo "  attempt 2 (Authorization Bearer) -> HTTP $HTTP2"

          if [ "$HTTP1" = "200" ] || [ "$HTTP2" = "200" ]; then
            echo "✅ One of the header styles succeeded."
            exit 0
          else
            echo "❌ Both header styles failed."
            exit 1
          fi
