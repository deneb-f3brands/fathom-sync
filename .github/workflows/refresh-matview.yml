name: refresh-matview

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'   # optional: run hourly; remove or change as you like
  push:
    branches:
      - main

jobs:
  call-edge-refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Validate secrets (quick)
        run: |
          if [ -z "${{ secrets.EDGE_REFRESH_URL }}" ]; then
            echo "❌ Missing EDGE_REFRESH_URL (set to your Supabase Edge function URL)"; exit 1;
          fi
          if [ -z "${{ secrets.EDGE_REFRESH_BEARER }}" ]; then
            echo "❌ Missing EDGE_REFRESH_BEARER (set to your Supabase service_role key)"; exit 1;
          fi
          echo "✅ Secrets exist"

      - name: Call Supabase Edge Function (Authorization Bearer)
        env:
          EDGE_URL: ${{ secrets.EDGE_REFRESH_URL }}
          EDGE_BEARER: ${{ secrets.EDGE_REFRESH_BEARER }}
        run: |
          set -euo pipefail
          BODY='{"source":"github_actions"}'
          echo "Calling Supabase Edge Function (Authorization: Bearer <token>)..."
          R=$(curl -s -w "\n%{http_code}" -X POST "$EDGE_URL" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $EDGE_BEARER" \
                -d "$BODY" || true)
          HTTP=$(echo "$R" | tail -n1 || echo "")
          RESP=$(echo "$R" | sed '$d' || echo "")
          echo "HTTP: $HTTP"
          echo "BODY:"
          echo "$RESP"
          if [ "$HTTP" = "200" ] || [ "$HTTP" = "201" ]; then
            echo "✅ matview refreshed."
            exit 0
          else
            echo "❌ Edge call failed with HTTP $HTTP"
            exit 1
          fi
