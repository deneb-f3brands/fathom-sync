name: refresh-matview

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'    # optional: run hourly - change or remove as needed
  push:
    branches:
      - main

jobs:
  call-edge-refresh:
    runs-on: ubuntu-latest
    env:
      EDGE_URL: ${{ secrets.EDGE_REFRESH_URL }}
      EDGE_SECRET: ${{ secrets.EDGE_REFRESH_SECRET }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Validate secrets (quick)
        run: |
          if [ -z "$EDGE_URL" ] || [ -z "$EDGE_SECRET" ]; then
            echo "ERROR: EDGE_URL or EDGE_SECRET not set. Check repository secrets."
            exit 2
          fi
          echo "DEBUG: EDGE_URL length = ${#EDGE_URL}"
          echo "DEBUG: EDGE_SECRET length = ${#EDGE_SECRET}"

      - name: Invoke Supabase Edge Function (x-refresh-secret)
        id: call-edge
        run: |
          set -euo pipefail

          echo "üöÄ Calling Supabase Edge Function with x-refresh-secret..."
          HTTP_STATUS=$(curl -s -o /tmp/edge_resp.txt -w "%{http_code}" -X POST "$EDGE_URL" \
            -H "Content-Type: application/json" \
            -H "x-refresh-secret: $EDGE_SECRET" \
            -d '{"source":"github_action"}' )

          echo "HTTP: $HTTP_STATUS"
          echo "BODY:"
          cat /tmp/edge_resp.txt || true

          if [ "$HTTP_STATUS" -ne 200 ] && [ "$HTTP_STATUS" -ne 201 ]; then
            echo "‚ö†Ô∏è Edge call failed (HTTP $HTTP_STATUS). Failing job."
            exit 1
          fi

          echo "Edge call succeeded."
